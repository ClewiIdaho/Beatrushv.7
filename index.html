<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RAPPERSTORE Rhythm Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #050508;
            --bg-glass: rgba(10, 10, 15, 0.95);
            --text: #ffffff;
            --text-dim: #888899;
            --accent: #00f0ff;
            --accent-secondary: #ff00aa;
            --accent-tertiary: #aaff00;
            --border-glow: rgba(0, 240, 255, 0.2);
            --lane-1: #00f0ff;
            --lane-2: #ff00aa;
            --lane-3: #aaff00;
            --lane-4: #ff6699;
            --perfect: #00ff88;
            --good: #ffcc00;
            --miss: #ff4466;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text);
        }

        .main-container {
            width: 100%;
            height: 100%;
            background: var(--bg-glass);
            overflow: hidden;
            position: relative;
        }

        .grid-bg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(0, 240, 255, 0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.015) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .scan-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), var(--accent-secondary), transparent);
            animation: scanMove 10s linear infinite;
            pointer-events: none;
            z-index: 1;
            opacity: 0.2;
        }

        @keyframes scanMove {
            0% { top: -2px; }
            100% { top: 100%; }
        }

        .reactive-bg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0;
        }

        .reactive-bg.pulse { animation: bgPulse 0.3s ease-out; }

        @keyframes bgPulse {
            0% { opacity: 0.3; }
            100% { opacity: 0; }
        }

        .reactive-bg.perfect-bg { background: radial-gradient(ellipse at 50% 70%, var(--perfect) 0%, transparent 50%); }
        .reactive-bg.good-bg { background: radial-gradient(ellipse at 50% 70%, var(--good) 0%, transparent 50%); }
        .reactive-bg.miss-bg { background: radial-gradient(ellipse at 50% 70%, var(--miss) 0%, transparent 50%); }

        #particles {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            animation: particleFloat 30s infinite ease-in-out;
            opacity: 0.25;
        }

        .particle.c1 { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
        .particle.c2 { background: var(--accent-secondary); box-shadow: 0 0 8px var(--accent-secondary); }

        @keyframes particleFloat {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0.15; }
            50% { transform: translateY(-80px) translateX(40px); opacity: 0.3; }
        }

        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            z-index: 10;
        }

        .screen.active { display: flex; }

        #menu-screen {
            justify-content: flex-start;
            align-items: center;
            padding: 20px;
            padding-top: 25px;
        }

        .menu-container {
            text-align: center;
            width: 100%;
            max-width: 480px;
            flex: 1;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============== FIXED LOGO - STAYS ON ONE LINE ============== */
        .logo-container {
            padding: 15px 5px 25px;
            position: relative;
            overflow: visible;
            width: 100%;
        }

        .logo {
            font-weight: 900;
            position: relative;
            display: block;
            white-space: nowrap;
            overflow: visible;
        }

        .logo-text {
            display: inline-block;
            position: relative;
            white-space: nowrap;
            font-size: clamp(1.8rem, 7vw, 3.2rem);
            letter-spacing: clamp(1px, 0.4vw, 5px);
            animation: logoFloat 4s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .logo-letter {
            display: inline-block;
            background: linear-gradient(180deg, #ff00aa 0%, #ff0066 50%, #cc0055 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: letterPop 3s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(255, 0, 170, 0.5));
        }

        .logo-letter:nth-child(1) { animation-delay: 0.0s; }
        .logo-letter:nth-child(2) { animation-delay: 0.06s; }
        .logo-letter:nth-child(3) { animation-delay: 0.12s; }
        .logo-letter:nth-child(4) { animation-delay: 0.18s; }
        .logo-letter:nth-child(5) { animation-delay: 0.24s; }
        .logo-letter:nth-child(6) { animation-delay: 0.30s; }
        .logo-letter:nth-child(7) { animation-delay: 0.36s; }
        .logo-letter:nth-child(8) { animation-delay: 0.42s; }
        .logo-letter:nth-child(9) { animation-delay: 0.48s; }
        .logo-letter:nth-child(10) { animation-delay: 0.54s; }
        .logo-letter:nth-child(11) { animation-delay: 0.60s; }

        @keyframes letterPop {
            0%, 100% { 
                transform: translateY(0) scale(1); 
                filter: drop-shadow(0 0 10px rgba(255, 0, 170, 0.5));
            }
            50% { 
                transform: translateY(-6px) scale(1.08); 
                filter: drop-shadow(0 0 20px rgba(255, 0, 170, 0.8)) drop-shadow(0 0 40px rgba(0, 240, 255, 0.4));
            }
        }

        .logo-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 150%;
            background: radial-gradient(ellipse at center, rgba(255, 0, 170, 0.25) 0%, transparent 60%);
            animation: glowPulse 2s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes glowPulse {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
        }

        .logo-underline {
            display: block;
            margin: 8px auto 0;
            width: 60%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), var(--accent-secondary), var(--accent), transparent);
            border-radius: 2px;
            animation: underlinePulse 2s ease-in-out infinite;
        }

        @keyframes underlinePulse {
            0%, 100% { opacity: 0.6; box-shadow: 0 0 10px var(--accent); width: 50%; }
            50% { opacity: 1; box-shadow: 0 0 20px var(--accent), 0 0 40px var(--accent-secondary); width: 70%; }
        }

        .subtitle {
            font-size: clamp(0.5rem, 1.5vw, 0.7rem);
            letter-spacing: clamp(3px, 1vw, 8px);
            color: var(--accent);
            margin-top: 12px;
            opacity: 0.8;
            animation: subtitleFade 3s ease-in-out infinite;
        }

        @keyframes subtitleFade {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .menu-header { margin-bottom: 12px; margin-top: 12px; }

        .highscore-banner {
            background: linear-gradient(135deg, rgba(0, 240, 255, 0.06), rgba(255, 0, 170, 0.06));
            border: 1px solid rgba(0, 240, 255, 0.15);
            border-radius: 10px;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .highscore-label { font-size: 0.6rem; letter-spacing: 2px; color: var(--text-dim); }
        .highscore-value { font-size: 1rem; font-weight: 800; color: var(--accent); }

        .song-list {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            padding: 10px;
            margin-bottom: 12px;
            flex: 1;
            max-height: 42vh;
            overflow-y: auto;
        }

        .song-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: left;
        }

        .song-item:hover {
            background: rgba(0, 240, 255, 0.08);
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .song-item:last-child { margin-bottom: 0; }

        .song-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .song-title { font-size: 0.95rem; font-weight: 700; }
        .song-highscore { font-size: 0.7rem; color: var(--accent); font-weight: 700; }

        .song-meta { 
            font-size: 0.65rem; 
            color: var(--text-dim); 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-wrap: wrap;
        }

        .difficulty-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.5rem;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .difficulty-badge.easy { background: linear-gradient(135deg, #00cc66, #00ff88); }
        .difficulty-badge.medium { background: linear-gradient(135deg, #ff9500, #ffcc00); }
        .difficulty-badge.hard { background: linear-gradient(135deg, #ff5500, #ff8844); }
        .difficulty-badge.expert { background: linear-gradient(135deg, #ff0055, #ff4488); }

        .instructions {
            font-size: 0.6rem;
            color: var(--text-dim);
            line-height: 1.8;
            margin-bottom: 8px;
        }

        .instructions span { color: var(--accent); font-weight: 600; }

        .key-display {
            display: inline-block;
            background: rgba(0, 240, 255, 0.12);
            border: 1px solid var(--accent);
            border-radius: 4px;
            padding: 2px 6px;
            font-weight: 700;
            font-family: monospace;
            margin: 0 1px;
            font-size: 0.8em;
        }

        #game-screen { padding: 0; position: relative; }

        .game-header {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.85) 0%, transparent 100%);
            height: 45px;
        }

        .song-info h2 { font-size: 0.85rem; font-weight: 700; color: #fff; }
        .song-info p { font-size: 0.55rem; color: var(--text-dim); letter-spacing: 1px; }

        .score-box { text-align: right; }
        .score-label { font-size: 0.5rem; letter-spacing: 2px; color: var(--text-dim); }
        .score-value { font-size: 1.2rem; font-weight: 900; color: var(--accent); }

        .health-container {
            position: absolute;
            top: 45px;
            left: 50%;
            transform: translateX(-50%);
            width: min(280px, 70vw);
            z-index: 100;
        }

        .health-bar-bg {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 3px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .health-bar-fill {
            height: 100%;
            width: 100%;
            background: var(--perfect);
            border-radius: 2px;
            transition: width 0.25s ease, background 0.25s ease;
            box-shadow: 0 0 8px var(--perfect);
        }

        .health-bar-fill.mid { background: var(--good); box-shadow: 0 0 8px var(--good); }
        .health-bar-fill.low { background: var(--miss); box-shadow: 0 0 8px var(--miss); animation: healthFlash 0.4s infinite; }

        @keyframes healthFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .health-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.5rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .miss-count { color: var(--miss); font-weight: 700; }

        .combo-container {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 100;
        }

        .combo-container.visible { opacity: 1; }
        .combo-container.bump { animation: comboBump 0.1s ease-out; }

        @keyframes comboBump {
            0% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.25); }
            100% { transform: translateY(-50%) scale(1); }
        }

        .combo-number {
            font-size: clamp(1.8rem, 7vw, 3rem);
            font-weight: 900;
            color: var(--accent);
            line-height: 1;
            text-shadow: 0 0 20px var(--accent);
        }

        .combo-label { font-size: 0.45rem; letter-spacing: 3px; color: var(--text-dim); }

        .combo-container.fire .combo-number {
            color: #ff6600;
            text-shadow: 0 0 20px #ff4400, 0 0 40px #ff0000;
            animation: fireGlow 0.2s infinite alternate;
        }

        @keyframes fireGlow {
            from { filter: brightness(1); }
            to { filter: brightness(1.3); }
        }

        .hit-feedback {
            position: absolute;
            left: 50%;
            top: 30%;
            transform: translate(-50%, -50%);
            font-size: clamp(1.3rem, 4.5vw, 2rem);
            font-weight: 900;
            letter-spacing: 3px;
            opacity: 0;
            pointer-events: none;
            z-index: 100;
            text-transform: uppercase;
        }

        .hit-feedback.show { animation: feedbackPop 0.35s ease-out forwards; }

        @keyframes feedbackPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
            100% { opacity: 0; transform: translate(-50%, -65%) scale(1); }
        }

        .hit-feedback.perfect { color: var(--perfect); text-shadow: 0 0 20px var(--perfect), 0 0 40px var(--perfect); }
        .hit-feedback.good { color: var(--good); text-shadow: 0 0 20px var(--good), 0 0 40px var(--good); }
        .hit-feedback.miss { color: var(--miss); text-shadow: 0 0 20px var(--miss), 0 0 40px var(--miss); }

        .game-area {
            position: absolute;
            top: 60px;
            bottom: 45px;
            left: 50%;
            transform: translateX(-50%);
            width: min(92vw, 500px);
            max-width: 500px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.5) 0%, rgba(0, 0, 0, 0.75) 100%);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(0, 240, 255, 0.15);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5), inset 0 0 60px rgba(0, 0, 0, 0.3);
        }

        .lanes {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
        }

        .lane {
            flex: 1;
            height: 100%;
            border-right: 1px solid rgba(255, 255, 255, 0.04);
            position: relative;
            transition: background 0.1s ease;
        }

        .lane:last-child { border-right: none; }

        .lane::before {
            content: '';
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 0;
            opacity: 0;
            transition: all 0.1s ease;
            pointer-events: none;
        }

        .lane:nth-child(1) { background: rgba(0, 240, 255, 0.08); }
        .lane:nth-child(2) { background: rgba(255, 0, 170, 0.08); }
        .lane:nth-child(3) { background: rgba(170, 255, 0, 0.08); }
        .lane:nth-child(4) { background: rgba(255, 102, 153, 0.08); }

        .lane:nth-child(1)::before { background: linear-gradient(to top, var(--lane-1), transparent); }
        .lane:nth-child(2)::before { background: linear-gradient(to top, var(--lane-2), transparent); }
        .lane:nth-child(3)::before { background: linear-gradient(to top, var(--lane-3), transparent); }
        .lane:nth-child(4)::before { background: linear-gradient(to top, var(--lane-4), transparent); }

        .lane.active::before { height: 100%; opacity: 0.12; }
        .lane.flash::before { height: 100%; opacity: 0.35; animation: laneFlash 0.2s ease-out; }

        @keyframes laneFlash {
            0% { opacity: 0.5; }
            100% { opacity: 0; }
        }

        .lane-labels {
            position: absolute;
            top: 10px; left: 0; right: 0;
            display: flex;
            z-index: 20;
            pointer-events: none;
        }

        .lane-label {
            flex: 1;
            text-align: center;
            font-size: clamp(1rem, 4vw, 1.5rem);
            font-weight: 900;
            color: rgba(255, 255, 255, 0.08);
        }

        .hit-line {
            position: absolute;
            bottom: 90px;
            left: 10px; right: 10px;
            height: 4px;
            background: linear-gradient(90deg, var(--lane-1), var(--lane-2), var(--lane-3), var(--lane-4));
            border-radius: 2px;
            z-index: 30;
            animation: hitLinePulse 1s ease-in-out infinite;
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.4), 0 0 30px rgba(255, 0, 170, 0.2);
        }

        @keyframes hitLinePulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; box-shadow: 0 0 20px rgba(0, 240, 255, 0.6), 0 0 40px rgba(255, 0, 170, 0.3); }
        }

        .hit-targets {
            position: absolute;
            bottom: 12px;
            left: 6px; right: 6px;
            display: flex;
            z-index: 35;
            gap: 6px;
            height: 72px;
        }

        .hit-target {
            flex: 1;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 14px;
            transition: all 0.05s ease;
            background: rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
        }

        .hit-target:nth-child(1) { border: 2px solid rgba(0, 240, 255, 0.4); box-shadow: inset 0 0 20px rgba(0, 240, 255, 0.1); }
        .hit-target:nth-child(2) { border: 2px solid rgba(255, 0, 170, 0.4); box-shadow: inset 0 0 20px rgba(255, 0, 170, 0.1); }
        .hit-target:nth-child(3) { border: 2px solid rgba(170, 255, 0, 0.4); box-shadow: inset 0 0 20px rgba(170, 255, 0, 0.1); }
        .hit-target:nth-child(4) { border: 2px solid rgba(255, 102, 153, 0.4); box-shadow: inset 0 0 20px rgba(255, 102, 153, 0.1); }

        .hit-target .target-arrow {
            width: 70%;
            height: 70%;
            opacity: 0.3;
            transition: all 0.05s ease;
        }

        .hit-target .target-arrow svg { width: 100%; height: 100%; }

        /* FIXED: Arrow rotations - Lane 0=LEFT, 1=DOWN, 2=UP, 3=RIGHT */
        .hit-target:nth-child(1) .target-arrow { transform: rotate(90deg); }
        .hit-target:nth-child(2) .target-arrow { transform: rotate(0deg); }
        .hit-target:nth-child(3) .target-arrow { transform: rotate(180deg); }
        .hit-target:nth-child(4) .target-arrow { transform: rotate(-90deg); }

        .hit-target.pressed { transform: scale(0.92); }
        .hit-target.pressed .target-arrow { opacity: 1; }

        .hit-target:nth-child(1).pressed { background: rgba(0, 240, 255, 0.3); border-color: var(--lane-1); box-shadow: 0 0 30px var(--lane-1), inset 0 0 25px rgba(0, 240, 255, 0.4); }
        .hit-target:nth-child(2).pressed { background: rgba(255, 0, 170, 0.3); border-color: var(--lane-2); box-shadow: 0 0 30px var(--lane-2), inset 0 0 25px rgba(255, 0, 170, 0.4); }
        .hit-target:nth-child(3).pressed { background: rgba(170, 255, 0, 0.3); border-color: var(--lane-3); box-shadow: 0 0 30px var(--lane-3), inset 0 0 25px rgba(170, 255, 0, 0.4); }
        .hit-target:nth-child(4).pressed { background: rgba(255, 102, 153, 0.3); border-color: var(--lane-4); box-shadow: 0 0 30px var(--lane-4), inset 0 0 25px rgba(255, 102, 153, 0.4); }

        .hit-target.hit-perfect { animation: targetPerfect 0.2s ease-out; }
        .hit-target.hit-good { animation: targetGood 0.2s ease-out; }

        @keyframes targetPerfect {
            0% { background: var(--perfect); box-shadow: 0 0 50px var(--perfect); transform: scale(1.1); }
            100% { background: rgba(0, 0, 0, 0.6); transform: scale(1); }
        }

        @keyframes targetGood {
            0% { background: var(--good); box-shadow: 0 0 40px var(--good); transform: scale(1.08); }
            100% { background: rgba(0, 0, 0, 0.6); transform: scale(1); }
        }

        .note {
            position: absolute;
            width: calc(25% - 8px);
            margin-left: 4px;
            height: 65px;
            z-index: 25;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: noteSpawn 0.15s ease-out;
        }

        @keyframes noteSpawn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .note.lane-0 { left: 0; }
        .note.lane-1 { left: 25%; }
        .note.lane-2 { left: 50%; }
        .note.lane-3 { left: 75%; }

        .note .rounded-arrow { width: 85%; height: 85%; position: relative; }
        .note .rounded-arrow svg { width: 100%; height: 100%; overflow: visible; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5)); }

        .note.hit { animation: noteHit 0.3s ease-out forwards; }

        @keyframes noteHit {
            0% { transform: scale(1); opacity: 1; filter: brightness(1); }
            30% { transform: scale(1.3); opacity: 0.8; filter: brightness(2); }
            100% { transform: scale(1.8); opacity: 0; filter: brightness(3); }
        }

        .hit-particle { position: absolute; border-radius: 50%; pointer-events: none; z-index: 40; }

        .touch-zones { position: absolute; bottom: 0; left: 0; right: 0; height: 120px; display: none; z-index: 50; }
        @media (pointer: coarse) { .touch-zones { display: flex; } }

        .touch-zone { flex: 1; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: 900; color: rgba(255, 255, 255, 0.04); border-right: 1px solid rgba(255, 255, 255, 0.02); -webkit-user-select: none; user-select: none; }
        .touch-zone:last-child { border-right: none; }
        .touch-zone:nth-child(1):active { background: linear-gradient(to top, rgba(0, 240, 255, 0.2), transparent); color: var(--lane-1); }
        .touch-zone:nth-child(2):active { background: linear-gradient(to top, rgba(255, 0, 170, 0.2), transparent); color: var(--lane-2); }
        .touch-zone:nth-child(3):active { background: linear-gradient(to top, rgba(170, 255, 0, 0.2), transparent); color: var(--lane-3); }
        .touch-zone:nth-child(4):active { background: linear-gradient(to top, rgba(255, 102, 153, 0.2), transparent); color: var(--lane-4); }

        .back-btn { position: absolute; bottom: 8px; left: 8px; padding: 8px 14px; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-dim); font-size: 0.65rem; font-weight: 700; letter-spacing: 1px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; z-index: 100; }
        .back-btn:hover { border-color: var(--accent); color: var(--accent); }

        .progress-bar { position: absolute; bottom: 0; left: 0; height: 3px; background: linear-gradient(90deg, var(--lane-1), var(--lane-2), var(--lane-3), var(--lane-4)); z-index: 100; transition: width 0.1s linear; box-shadow: 0 0 10px var(--accent); }

        .game-area.shake { animation: shake 0.3s ease-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(-50%); }
            20% { transform: translateX(-50%) translateX(-6px); }
            40% { transform: translateX(-50%) translateX(6px); }
            60% { transform: translateX(-50%) translateX(-4px); }
            80% { transform: translateX(-50%) translateX(4px); }
        }

        .countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: clamp(3.5rem, 12vw, 5.5rem); font-weight: 900; color: var(--accent); text-shadow: 0 0 30px var(--accent); z-index: 200; opacity: 0; pointer-events: none; }
        .countdown.show { animation: countdownPop 0.8s ease-out forwards; }
        @keyframes countdownPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(2.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        .game-over-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.92); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 300; }
        .game-over-overlay.active { display: flex; }
        .game-over-content { text-align: center; padding: 25px; animation: gameOverIn 0.4s ease-out; }
        @keyframes gameOverIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .game-over-title { font-size: clamp(1.8rem, 7vw, 2.8rem); font-weight: 900; color: var(--miss); text-shadow: 0 0 30px var(--miss), 0 0 60px var(--miss); margin-bottom: 5px; animation: gameOverGlow 0.8s ease-in-out infinite alternate; }
        @keyframes gameOverGlow { from { text-shadow: 0 0 30px var(--miss); } to { text-shadow: 0 0 50px var(--miss), 0 0 80px var(--miss); } }
        .game-over-subtitle { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 20px; letter-spacing: 2px; }
        .game-over-stats { background: rgba(255, 255, 255, 0.04); border-radius: 10px; padding: 12px 20px; margin-bottom: 18px; border: 1px solid rgba(255, 255, 255, 0.08); }
        .game-over-stat { display: flex; justify-content: space-between; padding: 8px 0; font-size: 0.85rem; }
        .game-over-stat-label { color: var(--text-dim); }
        .game-over-stat-value { font-weight: 800; color: var(--accent); }
        .game-over-buttons { display: flex; flex-direction: column; gap: 8px; }

        #results-screen { justify-content: center; align-items: center; padding: 15px; }
        .results-container { text-align: center; padding: 25px 20px; max-width: 380px; width: 100%; background: linear-gradient(135deg, rgba(0, 0, 0, 0.75), rgba(0, 240, 255, 0.02)); backdrop-filter: blur(15px); border: 1px solid var(--border-glow); border-radius: 20px; animation: resultsIn 0.5s ease-out; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5); }
        @keyframes resultsIn { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .results-title { font-size: 0.9rem; letter-spacing: 6px; color: var(--accent); margin-bottom: 6px; font-weight: 700; }
        .results-song { font-size: clamp(1.1rem, 4.5vw, 1.4rem); font-weight: 900; margin-bottom: 18px; color: #fff; }
        .results-grade { font-size: clamp(3rem, 12vw, 4.5rem); font-weight: 900; margin-bottom: 12px; animation: gradeIn 0.6s ease-out; }
        @keyframes gradeIn { 0% { transform: scale(3) rotate(-10deg); opacity: 0; } 60% { transform: scale(1.1) rotate(3deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        .results-grade.s { background: linear-gradient(135deg, #ff00ff, #00ffff, #ffff00, #ff00ff); background-size: 300% 300%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: gradeIn 0.6s ease-out, rainbowMove 1.2s linear infinite; filter: drop-shadow(0 0 25px #ff00ff); }
        @keyframes rainbowMove { 0% { background-position: 0% 50%; } 100% { background-position: 300% 50%; } }
        .results-grade.a { color: var(--perfect); text-shadow: 0 0 30px var(--perfect); }
        .results-grade.b { color: var(--good); text-shadow: 0 0 30px var(--good); }
        .results-grade.c { color: #ff8800; text-shadow: 0 0 30px #ff8800; }
        .results-grade.d { color: var(--miss); text-shadow: 0 0 30px var(--miss); }
        .new-record { display: inline-block; background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); color: white; padding: 6px 16px; border-radius: 15px; font-size: 0.7rem; font-weight: 800; letter-spacing: 2px; margin-bottom: 15px; animation: recordPop 0.4s ease-out, recordGlow 1.2s ease-in-out infinite 0.4s; }
        @keyframes recordPop { 0% { transform: scale(0); } 70% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes recordGlow { 0%, 100% { box-shadow: 0 4px 20px rgba(0, 240, 255, 0.3); } 50% { box-shadow: 0 4px 30px rgba(0, 240, 255, 0.5), 0 0 40px rgba(255, 0, 170, 0.3); } }
        .results-stats { margin-bottom: 18px; background: rgba(0, 0, 0, 0.25); border-radius: 12px; padding: 10px 15px; border: 1px solid rgba(255, 255, 255, 0.04); }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.04); font-size: 0.8rem; }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: var(--text-dim); letter-spacing: 1px; }
        .stat-value { font-weight: 800; }
        .stat-row.perfect .stat-value { color: var(--perfect); }
        .stat-row.good .stat-value { color: var(--good); }
        .stat-row.miss .stat-value { color: var(--miss); }
        .results-buttons { display: flex; flex-direction: column; gap: 8px; }

        .btn { padding: 12px 24px; font-size: 0.85rem; font-weight: 800; letter-spacing: 2px; border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; text-transform: uppercase; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); color: white; box-shadow: 0 4px 20px rgba(0, 240, 255, 0.25); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0, 240, 255, 0.35); }
        .btn-secondary { background: rgba(255, 255, 255, 0.05); color: var(--text-dim); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

        .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-glass); backdrop-filter: blur(15px); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; transition: opacity 0.4s ease; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loader { width: 50px; height: 50px; border: 3px solid rgba(255, 255, 255, 0.1); border-top-color: var(--accent); border-right-color: var(--accent-secondary); border-radius: 50%; animation: spin 0.6s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: var(--text-dim); font-size: 0.75rem; letter-spacing: 3px; animation: pulse 1s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.02); }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }
    </style>
</head><body>
    <div class="main-container">
        <div class="grid-bg"></div>
        <div class="scan-line"></div>
        <div id="particles"></div>
        <div class="reactive-bg" id="reactive-bg"></div>

        <div id="loading" class="loading-overlay">
            <div class="loader"></div>
            <div class="loading-text">LOADING...</div>
        </div>

        <!-- MENU SCREEN -->
        <div id="menu-screen" class="screen active">
            <div class="menu-container">
                <!-- FIXED LOGO - STAYS ON ONE LINE -->
                <div class="logo-container">
                    <div class="logo-glow"></div>
                    <h1 class="logo">
                        <span class="logo-text"><span class="logo-letter">R</span><span class="logo-letter">A</span><span class="logo-letter">P</span><span class="logo-letter">P</span><span class="logo-letter">E</span><span class="logo-letter">R</span><span class="logo-letter">S</span><span class="logo-letter">T</span><span class="logo-letter">O</span><span class="logo-letter">R</span><span class="logo-letter">E</span></span>
                    </h1>
                    <div class="logo-underline"></div>
                    <div class="subtitle">R H Y T H M &nbsp; G A M E</div>
                </div>

                <div class="menu-header">
                    <div class="highscore-banner">
                        <span class="highscore-label">TOTAL HIGH SCORE</span>
                        <span class="highscore-value" id="total-highscore">0</span>
                    </div>
                </div>

                <div class="song-list" id="song-list"></div>

                <div class="instructions">
                    <span>Desktop:</span> 
                    <span class="key-display">‚Üê</span>
                    <span class="key-display">‚Üì</span>
                    <span class="key-display">‚Üë</span>
                    <span class="key-display">‚Üí</span> or 
                    <span class="key-display">A</span>
                    <span class="key-display">S</span>
                    <span class="key-display">W</span>
                    <span class="key-display">D</span><br>
                    <span>Mobile:</span> Tap the lanes
                </div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="screen">
            <div class="game-header">
                <div class="song-info">
                    <h2 id="game-title">Song Title</h2>
                    <p id="game-producer">Producer</p>
                </div>
                <div class="score-box">
                    <div class="score-label">SCORE</div>
                    <div class="score-value" id="score">0</div>
                </div>
            </div>

            <div class="health-container">
                <div class="health-bar-bg">
                    <div class="health-bar-fill" id="health-bar"></div>
                </div>
                <div class="health-label">
                    <span>HEALTH</span>
                    <span class="miss-count" id="miss-display">0 / 20</span>
                </div>
            </div>

            <div class="combo-container" id="combo-container">
                <div class="combo-number" id="combo">0</div>
                <div class="combo-label">COMBO</div>
            </div>

            <div class="hit-feedback" id="feedback"></div>

            <div class="game-area" id="game-area">
                <div class="lane-labels">
                    <div class="lane-label">‚Üê</div>
                    <div class="lane-label">‚Üì</div>
                    <div class="lane-label">‚Üë</div>
                    <div class="lane-label">‚Üí</div>
                </div>

                <div class="lanes" id="lanes">
                    <div class="lane" data-lane="0"></div>
                    <div class="lane" data-lane="1"></div>
                    <div class="lane" data-lane="2"></div>
                    <div class="lane" data-lane="3"></div>
                </div>

                <div class="hit-line"></div>

                <!-- HIT TARGETS WITH ROUNDED ARROWS -->
                <div class="hit-targets" id="hit-targets">
                    <!-- Lane 0: LEFT Arrow -->
                    <div class="hit-target" data-lane="0">
                        <div class="target-arrow">
                            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="tg1" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#66ffff"/>
                                        <stop offset="50%" style="stop-color:#00f0ff"/>
                                        <stop offset="100%" style="stop-color:#00a0aa"/>
                                    </linearGradient>
                                </defs>
                                <path d="M50 8 Q68 8 68 26 L68 42 L82 42 Q90 42 84 52 L54 86 Q50 91 46 86 L16 52 Q10 42 18 42 L32 42 L32 26 Q32 8 50 8 Z" fill="url(#tg1)" stroke="#00f0ff" stroke-width="2"/>
                                <path d="M50 16 Q60 16 60 26 L60 50 L72 50 L50 76 L28 50 L40 50 L40 26 Q40 16 50 16 Z" fill="rgba(255,255,255,0.25)"/>
                            </svg>
                        </div>
                    </div>
                    <!-- Lane 1: DOWN Arrow -->
                    <div class="hit-target" data-lane="1">
                        <div class="target-arrow">
                            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="tg2" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#ff66cc"/>
                                        <stop offset="50%" style="stop-color:#ff00aa"/>
                                        <stop offset="100%" style="stop-color:#aa0066"/>
                                    </linearGradient>
                                </defs>
                                <path d="M50 8 Q68 8 68 26 L68 42 L82 42 Q90 42 84 52 L54 86 Q50 91 46 86 L16 52 Q10 42 18 42 L32 42 L32 26 Q32 8 50 8 Z" fill="url(#tg2)" stroke="#ff00aa" stroke-width="2"/>
                                <path d="M50 16 Q60 16 60 26 L60 50 L72 50 L50 76 L28 50 L40 50 L40 26 Q40 16 50 16 Z" fill="rgba(255,255,255,0.25)"/>
                            </svg>
                        </div>
                    </div>
                    <!-- Lane 2: UP Arrow -->
                    <div class="hit-target" data-lane="2">
                        <div class="target-arrow">
                            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="tg3" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#ccff66"/>
                                        <stop offset="50%" style="stop-color:#aaff00"/>
                                        <stop offset="100%" style="stop-color:#669900"/>
                                    </linearGradient>
                                </defs>
                                <path d="M50 8 Q68 8 68 26 L68 42 L82 42 Q90 42 84 52 L54 86 Q50 91 46 86 L16 52 Q10 42 18 42 L32 42 L32 26 Q32 8 50 8 Z" fill="url(#tg3)" stroke="#aaff00" stroke-width="2"/>
                                <path d="M50 16 Q60 16 60 26 L60 50 L72 50 L50 76 L28 50 L40 50 L40 26 Q40 16 50 16 Z" fill="rgba(255,255,255,0.25)"/>
                            </svg>
                        </div>
                    </div>
                    <!-- Lane 3: RIGHT Arrow -->
                    <div class="hit-target" data-lane="3">
                        <div class="target-arrow">
                            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="tg4" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#ffaacc"/>
                                        <stop offset="50%" style="stop-color:#ff6699"/>
                                        <stop offset="100%" style="stop-color:#cc3366"/>
                                    </linearGradient>
                                </defs>
                                <path d="M50 8 Q68 8 68 26 L68 42 L82 42 Q90 42 84 52 L54 86 Q50 91 46 86 L16 52 Q10 42 18 42 L32 42 L32 26 Q32 8 50 8 Z" fill="url(#tg4)" stroke="#ff6699" stroke-width="2"/>
                                <path d="M50 16 Q60 16 60 26 L60 50 L72 50 L50 76 L28 50 L40 50 L40 26 Q40 16 50 16 Z" fill="rgba(255,255,255,0.25)"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="touch-zones" id="touch-zones">
                    <div class="touch-zone" data-lane="0">‚Üê</div>
                    <div class="touch-zone" data-lane="1">‚Üì</div>
                    <div class="touch-zone" data-lane="2">‚Üë</div>
                    <div class="touch-zone" data-lane="3">‚Üí</div>
                </div>

                <div class="countdown" id="countdown"></div>
            </div>

            <div class="game-over-overlay" id="game-over-overlay">
                <div class="game-over-content">
                    <div class="game-over-title">GAME OVER</div>
                    <div class="game-over-subtitle">Too many misses!</div>
                    <div class="game-over-stats">
                        <div class="game-over-stat">
                            <span class="game-over-stat-label">SCORE</span>
                            <span class="game-over-stat-value" id="gameover-score">0</span>
                        </div>
                        <div class="game-over-stat">
                            <span class="game-over-stat-label">MAX COMBO</span>
                            <span class="game-over-stat-value" id="gameover-combo">0</span>
                        </div>
                    </div>
                    <div class="game-over-buttons">
                        <button class="btn btn-primary" id="gameover-retry-btn">TRY AGAIN</button>
                        <button class="btn btn-secondary" id="gameover-menu-btn">SONG SELECT</button>
                    </div>
                </div>
            </div>

            <div class="progress-bar" id="progress"></div>
            <button class="back-btn" id="back-btn">‚Üê BACK</button>
        </div>

        <!-- RESULTS SCREEN -->
        <div id="results-screen" class="screen">
            <div class="results-container">
                <div class="results-title">COMPLETE</div>
                <div class="results-song" id="results-song">Song Name</div>
                <div class="results-grade" id="results-grade">A</div>
                <div class="new-record" id="new-record" style="display: none;">üèÜ NEW RECORD!</div>
                <div class="results-stats">
                    <div class="stat-row">
                        <span class="stat-label">SCORE</span>
                        <span class="stat-value" id="results-score">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">BEST</span>
                        <span class="stat-value" id="results-best">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">MAX COMBO</span>
                        <span class="stat-value" id="results-combo">0</span>
                    </div>
                    <div class="stat-row perfect">
                        <span class="stat-label">PERFECT</span>
                        <span class="stat-value" id="results-perfect">0</span>
                    </div>
                    <div class="stat-row good">
                        <span class="stat-label">GOOD</span>
                        <span class="stat-value" id="results-good">0</span>
                    </div>
                    <div class="stat-row miss">
                        <span class="stat-label">MISS</span>
                        <span class="stat-value" id="results-miss">0</span>
                    </div>
                </div>
                <div class="results-buttons">
                    <button class="btn btn-primary" id="retry-btn">PLAY AGAIN</button>
                    <button class="btn btn-secondary" id="menu-btn">SONG SELECT</button>
                </div>
            </div>
        </div>
    </div>    <script>
        // ============== SONG DATA ==============
        const SONGS = [
            {
                id: '808-sakura',
                title: '808 Sakura',
                producer: 'RAPPERSTORE',
                bpm: 95,
                difficulty: 'EASY',
                duration: 198000,
                audio: 'https://static.wixstatic.com/mp3/7ca975_d0b51d112a8044448753a3af3f9b5e52.wav'
            },
            {
                id: 'all-my-life',
                title: 'All My Life',
                producer: 'RAPPERSTORE',
                bpm: 135,
                difficulty: 'MEDIUM',
                duration: 261000,
                audio: 'https://static.wixstatic.com/mp3/7ca975_5add0ebbebe54e5e827ef976e1b93cfb.wav'
            },
            {
                id: 'out-of-the-studio',
                title: 'Out of the Studio',
                producer: 'RAPPERSTORE',
                bpm: 140,
                difficulty: 'HARD',
                duration: 146000,
                audio: 'https://static.wixstatic.com/mp3/7ca975_07a666ff56324fdc854b08e515c1e8e8.wav'
            },
            {
                id: 'in-love-with-a-gangsta',
                title: 'In Love With a Gangsta',
                producer: 'RAPPERSTORE',
                bpm: 146,
                difficulty: 'EXPERT',
                duration: 141000,
                audio: 'https://static.wixstatic.com/mp3/7ca975_a5ace2949d424d9abf717e762411a406.wav'
            }
        ];

        // ============== CONFIG ==============
        const CONFIG = {
            noteSpeed: 1800,
            perfectWindow: 55,
            goodWindow: 125,
            missWindow: 185,
            perfectScore: 100,
            goodScore: 50,
            hitLineOffset: 90,
            maxMisses: 20
        };

        // ============== FIXED KEY MAPPING ==============
        // Lane 0 = LEFT (A key, Left Arrow)
        // Lane 1 = DOWN (S key, Down Arrow)
        // Lane 2 = UP (W key, Up Arrow)
        // Lane 3 = RIGHT (D key, Right Arrow)
        const KEYS = {
            'ArrowLeft': 0,
            'ArrowDown': 1,
            'ArrowUp': 2,
            'ArrowRight': 3,
            'KeyA': 0,
            'KeyS': 1,
            'KeyW': 2,
            'KeyD': 3,
            'a': 0,
            's': 1,
            'w': 2,
            'd': 3
        };

        // ============== GAME STATE ==============
        let gameState = {
            isPlaying: false,
            isGameOver: false,
            currentSong: null,
            notes: [],
            activeNotes: [],
            nextNoteIndex: 0,
            score: 0,
            combo: 0,
            maxCombo: 0,
            stats: { perfect: 0, good: 0, miss: 0 },
            startTime: 0,
            audio: null,
            animationFrame: null
        };

        // ============== HIGH SCORES ==============
        const HighScores = {
            key: 'rapperstore_v9',
            getAll() {
                try { return JSON.parse(localStorage.getItem(this.key)) || {}; }
                catch (e) { return {}; }
            },
            get(id) { return this.getAll()[id] || { score: 0, grade: '-', maxCombo: 0 }; },
            set(id, score, grade, maxCombo) {
                const all = this.getAll();
                if (score > (all[id]?.score || 0)) {
                    all[id] = { score, grade, maxCombo };
                    try { localStorage.setItem(this.key, JSON.stringify(all)); } catch (e) {}
                    return true;
                }
                return false;
            },
            getTotal() { return Object.values(this.getAll()).reduce((s, x) => s + (x.score || 0), 0); }
        };

        // ============== DOM ==============
        const DOM = {
            screens: {
                menu: document.getElementById('menu-screen'),
                game: document.getElementById('game-screen'),
                results: document.getElementById('results-screen')
            },
            loading: document.getElementById('loading'),
            songList: document.getElementById('song-list'),
            totalHighscore: document.getElementById('total-highscore'),
            gameArea: document.getElementById('game-area'),
            lanes: document.getElementById('lanes'),
            hitTargets: document.querySelectorAll('.hit-target'),
            touchZones: document.querySelectorAll('.touch-zone'),
            score: document.getElementById('score'),
            combo: document.getElementById('combo'),
            comboContainer: document.getElementById('combo-container'),
            feedback: document.getElementById('feedback'),
            countdown: document.getElementById('countdown'),
            progress: document.getElementById('progress'),
            gameTitle: document.getElementById('game-title'),
            gameProducer: document.getElementById('game-producer'),
            particles: document.getElementById('particles'),
            newRecord: document.getElementById('new-record'),
            reactiveBg: document.getElementById('reactive-bg'),
            healthBar: document.getElementById('health-bar'),
            missDisplay: document.getElementById('miss-display'),
            gameOverOverlay: document.getElementById('game-over-overlay'),
            gameoverScore: document.getElementById('gameover-score'),
            gameoverCombo: document.getElementById('gameover-combo')
        };

        // ============== CHART GENERATOR ==============
        function generateChart(song) {
            const notes = [];
            const beat = 60000 / song.bpm;
            const dur = song.duration;
            const diff = {
                'EASY': { base: 0.5, max: 1, dbl: 0.03, tri: 0 },
                'MEDIUM': { base: 0.75, max: 1.5, dbl: 0.1, tri: 0.02 },
                'HARD': { base: 1.1, max: 2, dbl: 0.18, tri: 0.05 },
                'EXPERT': { base: 1.5, max: 2.8, dbl: 0.28, tri: 0.1 }
            }[song.difficulty] || { base: 0.75, max: 1.5, dbl: 0.1, tri: 0.02 };

            let t = 3000, idx = 0;
            while (t < dur - 2000) {
                const prog = t / dur;
                const dens = diff.base + (diff.max - diff.base) * Math.sin(prog * Math.PI);
                const interval = beat / dens;
                let lanes;
                const r = Math.random();

                if (r < diff.tri && song.difficulty !== 'EASY') {
                    const skip = Math.floor(Math.random() * 4);
                    lanes = [0, 1, 2, 3].filter(l => l !== skip);
                } else if (r < diff.dbl) {
                    const a = Math.floor(Math.random() * 4);
                    let b = Math.floor(Math.random() * 4);
                    while (b === a) b = Math.floor(Math.random() * 4);
                    lanes = [a, b];
                } else {
                    lanes = [Math.floor(Math.random() * 4)];
                }

                lanes.forEach(lane => {
                    notes.push({ id: `n${notes.length}`, time: Math.round(t), lane, hit: false, spawned: false });
                });

                t += interval;
                idx++;
                if (Math.random() < 0.1) t += beat;
            }
            return notes;
        }

        // ============== PARTICLES ==============
        function createParticles() {
            DOM.particles.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const p = document.createElement('div');
                p.className = `particle ${i % 2 === 0 ? 'c1' : 'c2'}`;
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                p.style.width = p.style.height = (2 + Math.random() * 3) + 'px';
                p.style.animationDelay = Math.random() * 30 + 's';
                DOM.particles.appendChild(p);
            }
        }

        // ============== EFFECTS ==============
        function triggerBg(type) {
            DOM.reactiveBg.className = 'reactive-bg';
            void DOM.reactiveBg.offsetWidth;
            DOM.reactiveBg.classList.add(type + '-bg', 'pulse');
        }

        function triggerLaneFlash(lane) {
            const el = document.querySelectorAll('.lane')[lane];
            el.classList.remove('flash');
            void el.offsetWidth;
            el.classList.add('flash');
        }

        function createHitParticles(lane, type) {
            const target = DOM.hitTargets[lane];
            const rect = target.getBoundingClientRect();
            const gameRect = DOM.gameArea.getBoundingClientRect();
            const cx = rect.left - gameRect.left + rect.width / 2;
            const cy = rect.top - gameRect.top + rect.height / 2;
            const colors = {
                perfect: ['#00ff88', '#00ffcc', '#88ffdd', '#fff', '#00f0ff'],
                good: ['#ffcc00', '#ffdd44', '#ffee88', '#fff'],
                miss: ['#ff4455', '#ff6677']
            }[type] || ['#fff'];
            const count = type === 'perfect' ? 20 : type === 'good' ? 12 : 6;

            for (let i = 0; i < count; i++) {
                const p = document.createElement('div');
                p.className = 'hit-particle';
                p.style.left = cx + 'px';
                p.style.top = cy + 'px';
                const size = 4 + Math.random() * 8;
                p.style.width = p.style.height = size + 'px';
                p.style.background = colors[Math.floor(Math.random() * colors.length)];
                p.style.boxShadow = `0 0 ${size}px ${p.style.background}`;
                DOM.gameArea.appendChild(p);

                const angle = (Math.PI * 2 * i) / count + (Math.random() - 0.5) * 0.5;
                const speed = 120 + Math.random() * 150;
                const vx = Math.cos(angle) * speed;
                let vy = Math.sin(angle) * speed;
                let x = 0, y = 0, opacity = 1;

                const animate = () => {
                    x += vx * 0.016;
                    vy += 300 * 0.016;
                    y += vy * 0.016;
                    opacity -= 0.04;
                    p.style.transform = `translate(${x}px, ${y}px) scale(${opacity})`;
                    p.style.opacity = Math.max(0, opacity);
                    if (opacity > 0) requestAnimationFrame(animate);
                    else p.remove();
                };
                requestAnimationFrame(animate);
            }
        }

        // ============== HEALTH ==============
        function updateHealth() {
            const m = gameState.stats.miss;
            const pct = Math.max(0, (CONFIG.maxMisses - m) / CONFIG.maxMisses * 100);
            DOM.healthBar.style.width = pct + '%';
            DOM.missDisplay.textContent = `${m} / ${CONFIG.maxMisses}`;
            DOM.healthBar.classList.remove('mid', 'low');
            if (pct <= 25) DOM.healthBar.classList.add('low');
            else if (pct <= 50) DOM.healthBar.classList.add('mid');
        }

        function checkGameOver() {
            if (gameState.stats.miss >= CONFIG.maxMisses && !gameState.isGameOver) {
                gameState.isGameOver = true;
                gameState.isPlaying = false;
                if (gameState.audio) gameState.audio.pause();
                if (gameState.animationFrame) cancelAnimationFrame(gameState.animationFrame);
                DOM.gameoverScore.textContent = gameState.score.toLocaleString();
                DOM.gameoverCombo.textContent = gameState.maxCombo;
                DOM.gameOverOverlay.classList.add('active');
                HighScores.set(gameState.currentSong.id, gameState.score, 'D', gameState.maxCombo);
            }
        }

        function hideGameOver() { DOM.gameOverOverlay.classList.remove('active'); }

        // ============== UI ==============
        function showScreen(name) {
            Object.values(DOM.screens).forEach(s => s.classList.remove('active'));
            DOM.screens[name].classList.add('active');
        }

        function populateSongs() {
            DOM.songList.innerHTML = '';
            SONGS.forEach(song => {
                const hs = HighScores.get(song.id);
                const mins = Math.floor(song.duration / 60000);
                const secs = String(Math.floor((song.duration % 60000) / 1000)).padStart(2, '0');
                const el = document.createElement('div');
                el.className = 'song-item';
                el.innerHTML = `
                    <div class="song-header">
                        <div class="song-title">${song.title}</div>
                        ${hs.score > 0 ? `<div class="song-highscore">üëë ${hs.score.toLocaleString()}</div>` : ''}
                    </div>
                    <div class="song-meta">
                        <span>${song.producer}</span>
                        <span class="difficulty-badge ${song.difficulty.toLowerCase()}">${song.difficulty}</span>
                        <span>${song.bpm} BPM</span>
                        <span>${mins}:${secs}</span>
                    </div>
                `;
                el.onclick = () => selectSong(song);
                DOM.songList.appendChild(el);
            });
            DOM.totalHighscore.textContent = HighScores.getTotal().toLocaleString();
        }

        function loadAudio(url) {
            return new Promise((resolve, reject) => {
                const a = new Audio();
                a.crossOrigin = 'anonymous';
                a.preload = 'auto';
                a.oncanplaythrough = () => resolve(a);
                a.onerror = () => reject();
                a.src = url;
                a.load();
            });
        }

        async function selectSong(song) {
            DOM.loading.classList.remove('hidden');
            try {
                gameState.audio = await loadAudio(song.audio);
                gameState.currentSong = song;
                gameState.notes = generateChart(song);
                DOM.gameTitle.textContent = song.title;
                DOM.gameProducer.textContent = song.producer;
                showScreen('game');
                startCountdown();
            } catch (e) {
                alert('Failed to load audio. Please try again.');
            }
            DOM.loading.classList.add('hidden');
        }

        // ============== COUNTDOWN ==============
        function startCountdown() {
            resetGame();
            let count = 3;
            DOM.countdown.textContent = count;
            DOM.countdown.classList.add('show');

            const tick = setInterval(() => {
                count--;
                if (count > 0) {
                    DOM.countdown.classList.remove('show');
                    void DOM.countdown.offsetWidth;
                    DOM.countdown.textContent = count;
                    DOM.countdown.classList.add('show');
                } else if (count === 0) {
                    DOM.countdown.classList.remove('show');
                    void DOM.countdown.offsetWidth;
                    DOM.countdown.textContent = 'GO!';
                    DOM.countdown.classList.add('show');
                } else {
                    clearInterval(tick);
                    DOM.countdown.classList.remove('show');
                    startGame();
                }
            }, 800);
        }

        // ============== GAME LOGIC ==============
        function resetGame() {
            gameState.score = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.stats = { perfect: 0, good: 0, miss: 0 };
            gameState.nextNoteIndex = 0;
            gameState.activeNotes = [];
            gameState.isPlaying = false;
            gameState.isGameOver = false;
            gameState.notes.forEach(n => { n.hit = false; n.spawned = false; });
            document.querySelectorAll('.note').forEach(n => n.remove());
            hideGameOver();
            updateUI();
            updateHealth();
        }

        function startGame() {
            gameState.isPlaying = true;
            gameState.startTime = performance.now();
            gameState.audio.currentTime = 0;
            gameState.audio.play();
            gameLoop();
        }

        function gameLoop() {
            if (!gameState.isPlaying) return;

            const now = performance.now();
            const elapsed = now - gameState.startTime;
            const gameHeight = DOM.gameArea.offsetHeight;
            const hitY = gameHeight - CONFIG.hitLineOffset;

            // Spawn notes
            while (gameState.nextNoteIndex < gameState.notes.length) {
                const note = gameState.notes[gameState.nextNoteIndex];
                if (note.time - elapsed <= CONFIG.noteSpeed) {
                    spawnNote(note);
                    gameState.nextNoteIndex++;
                } else break;
            }

            // Update notes
            gameState.activeNotes = gameState.activeNotes.filter(note => {
                if (note.hit) return false;

                const noteEl = document.getElementById(note.id);
                if (!noteEl) return false;

                const timeUntilHit = note.time - elapsed;
                const progress = 1 - (timeUntilHit / CONFIG.noteSpeed);
                const noteY = progress * hitY;

                noteEl.style.top = noteY + 'px';

                // Miss check
                if (elapsed > note.time + CONFIG.missWindow) {
                    handleMiss(note, noteEl);
                    return false;
                }
                return true;
            });

            // Progress
            DOM.progress.style.width = (elapsed / gameState.currentSong.duration * 100) + '%';

            // End check
            if (elapsed >= gameState.currentSong.duration || 
                (gameState.nextNoteIndex >= gameState.notes.length && gameState.activeNotes.length === 0)) {
                endGame();
                return;
            }

            gameState.animationFrame = requestAnimationFrame(gameLoop);
        }

        // ============== SPAWN NOTE WITH CORRECT ARROW ROTATION ==============
        function spawnNote(note) {
            note.spawned = true;
            const el = document.createElement('div');
            el.id = note.id;
            el.className = `note lane-${note.lane}`;
            
            // Color configs per lane
            const colors = [
                { light: '#66ffff', main: '#00f0ff', dark: '#00a0aa', stroke: '#00f0ff' },  // Lane 0: LEFT - Cyan
                { light: '#ff66cc', main: '#ff00aa', dark: '#aa0066', stroke: '#ff00aa' },  // Lane 1: DOWN - Magenta
                { light: '#ccff66', main: '#aaff00', dark: '#669900', stroke: '#aaff00' },  // Lane 2: UP - Green
                { light: '#ffaacc', main: '#ff6699', dark: '#cc3366', stroke: '#ff6699' }   // Lane 3: RIGHT - Pink
            ][note.lane];

            // FIXED ROTATIONS: The base SVG arrow points DOWN
            // Lane 0 = LEFT arrow = rotate 90deg (clockwise)
            // Lane 1 = DOWN arrow = rotate 0deg (no rotation)
            // Lane 2 = UP arrow = rotate 180deg
            // Lane 3 = RIGHT arrow = rotate -90deg (counter-clockwise)
            const rotation = [90, 0, 180, -90][note.lane];
            
            el.innerHTML = `
                <div class="rounded-arrow" style="transform: rotate(${rotation}deg);">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="ng${note.id}" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:${colors.light}"/>
                                <stop offset="50%" style="stop-color:${colors.main}"/>
                                <stop offset="100%" style="stop-color:${colors.dark}"/>
                            </linearGradient>
                            <filter id="glow${note.id}" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur stdDeviation="3" result="blur"/>
                                <feComposite in="SourceGraphic" in2="blur" operator="over"/>
                            </filter>
                        </defs>
                        
                        <!-- Outer glow -->
                        <path d="M50 8 Q68 8 68 26 L68 42 L82 42 Q90 42 84 52 L54 86 Q50 91 46 86 L16 52 Q10 42 18 42 L32 42 L32 26 Q32 8 50 8 Z" 
                              fill="${colors.main}" 
                              opacity="0.4"
                              filter="url(#glow${note.id})"/>
                        
                        <!-- Main arrow body -->
                        <path d="M50 8 Q68 8 68 26 L68 42 L82 42 Q90 42 84 52 L54 86 Q50 91 46 86 L16 52 Q10 42 18 42 L32 42 L32 26 Q32 8 50 8 Z" 
                              fill="url(#ng${note.id})" 
                              stroke="${colors.stroke}" 
                              stroke-width="2"/>
                        
                        <!-- Inner highlight -->
                        <path d="M50 16 Q60 16 60 26 L60 50 L72 50 L50 76 L28 50 L40 50 L40 26 Q40 16 50 16 Z" 
                              fill="rgba(255,255,255,0.3)"/>
                        
                        <!-- Top shine -->
                        <ellipse cx="50" cy="20" rx="8" ry="5" fill="rgba(255,255,255,0.5)"/>
                    </svg>
                </div>
            `;
            
            el.style.top = '-70px';
            DOM.lanes.appendChild(el);
            gameState.activeNotes.push(note);
        }

        function handleHit(lane) {
            if (!gameState.isPlaying || gameState.isGameOver) return;

            const now = performance.now();
            const elapsed = now - gameState.startTime;

            // Activate target
            DOM.hitTargets[lane].classList.add('pressed');
            setTimeout(() => DOM.hitTargets[lane].classList.remove('pressed'), 100);

            // Find closest note
            let closest = null, closestDiff = Infinity;
            gameState.activeNotes.forEach(note => {
                if (note.lane === lane && !note.hit) {
                    const diff = Math.abs(note.time - elapsed);
                    if (diff < closestDiff && diff <= CONFIG.missWindow) {
                        closest = note;
                        closestDiff = diff;
                    }
                }
            });

            if (closest) {
                closest.hit = true;
                const noteEl = document.getElementById(closest.id);

                if (closestDiff <= CONFIG.perfectWindow) {
                    scoreHit('perfect', lane, noteEl);
                } else if (closestDiff <= CONFIG.goodWindow) {
                    scoreHit('good', lane, noteEl);
                } else {
                    scoreHit('good', lane, noteEl);
                }
            }
        }

        function scoreHit(type, lane, noteEl) {
            const points = type === 'perfect' ? CONFIG.perfectScore : CONFIG.goodScore;
            const multiplier = 1 + Math.floor(gameState.combo / 10) * 0.1;
            gameState.score += Math.round(points * multiplier);
            gameState.combo++;
            gameState.maxCombo = Math.max(gameState.maxCombo, gameState.combo);
            gameState.stats[type]++;

            // Effects
            noteEl.classList.add('hit');
            setTimeout(() => noteEl.remove(), 300);

            DOM.hitTargets[lane].classList.add(`hit-${type}`);
            setTimeout(() => DOM.hitTargets[lane].classList.remove(`hit-${type}`), 200);

            triggerLaneFlash(lane);
            triggerBg(type);
            createHitParticles(lane, type);
            showFeedback(type);
            updateUI();
        }

        function handleMiss(note, noteEl) {
            gameState.combo = 0;
            gameState.stats.miss++;
            noteEl.style.opacity = '0.3';
            noteEl.style.filter = 'grayscale(1)';
            setTimeout(() => noteEl.remove(), 200);

            DOM.gameArea.classList.add('shake');
            setTimeout(() => DOM.gameArea.classList.remove('shake'), 300);

            triggerBg('miss');
            showFeedback('miss');
            updateUI();
            updateHealth();
            checkGameOver();
        }

        function showFeedback(type) {
            DOM.feedback.className = 'hit-feedback';
            DOM.feedback.textContent = type.toUpperCase();
            void DOM.feedback.offsetWidth;
            DOM.feedback.classList.add('show', type);
        }

        function updateUI() {
            DOM.score.textContent = gameState.score.toLocaleString();
            DOM.combo.textContent = gameState.combo;

            if (gameState.combo >= 5) {
                DOM.comboContainer.classList.add('visible');
                DOM.comboContainer.classList.remove('bump');
                void DOM.comboContainer.offsetWidth;
                DOM.comboContainer.classList.add('bump');
                DOM.comboContainer.classList.toggle('fire', gameState.combo >= 20);
            } else {
                DOM.comboContainer.classList.remove('visible', 'fire');
            }
        }

        function endGame() {
            gameState.isPlaying = false;
            if (gameState.audio) gameState.audio.pause();
            if (gameState.animationFrame) cancelAnimationFrame(gameState.animationFrame);

            const total = gameState.stats.perfect + gameState.stats.good + gameState.stats.miss;
            const accuracy = total > 0 ? (gameState.stats.perfect + gameState.stats.good * 0.5) / total : 0;

            let grade;
            if (accuracy >= 0.95 && gameState.stats.miss === 0) grade = 'S';
            else if (accuracy >= 0.9) grade = 'A';
            else if (accuracy >= 0.75) grade = 'B';
            else if (accuracy >= 0.5) grade = 'C';
            else grade = 'D';

            const isRecord = HighScores.set(gameState.currentSong.id, gameState.score, grade, gameState.maxCombo);
            const best = HighScores.get(gameState.currentSong.id);

            // Update results
            document.getElementById('results-song').textContent = gameState.currentSong.title;
            document.getElementById('results-grade').textContent = grade;
            document.getElementById('results-grade').className = 'results-grade ' + grade.toLowerCase();
            document.getElementById('results-score').textContent = gameState.score.toLocaleString();
            document.getElementById('results-best').textContent = best.score.toLocaleString();
            document.getElementById('results-combo').textContent = gameState.maxCombo;
            document.getElementById('results-perfect').textContent = gameState.stats.perfect;
            document.getElementById('results-good').textContent = gameState.stats.good;
            document.getElementById('results-miss').textContent = gameState.stats.miss;

            DOM.newRecord.style.display = isRecord ? 'inline-block' : 'none';

            setTimeout(() => showScreen('results'), 500);
        }

        // ============== INPUT HANDLERS ==============
        document.addEventListener('keydown', e => {
            if (e.repeat) return;
            const lane = KEYS[e.code] ?? KEYS[e.key];
            if (lane !== undefined) {
                e.preventDefault();
                handleHit(lane);
            }
            if (e.code === 'Escape' && gameState.isPlaying) {
                gameState.isPlaying = false;
                if (gameState.audio) gameState.audio.pause();
                showScreen('menu');
            }
        });

        document.addEventListener('keyup', e => {
            const lane = KEYS[e.code] ?? KEYS[e.key];
            if (lane !== undefined) {
                DOM.hitTargets[lane].classList.remove('pressed');
            }
        });

        DOM.touchZones.forEach(zone => {
            const lane = parseInt(zone.dataset.lane);
            zone.addEventListener('touchstart', e => { e.preventDefault(); handleHit(lane); }, { passive: false });
        });

        DOM.hitTargets.forEach(target => {
            const lane = parseInt(target.dataset.lane);
            target.addEventListener('touchstart', e => { e.preventDefault(); handleHit(lane); }, { passive: false });
        });

        // ============== BUTTON HANDLERS ==============
        document.getElementById('back-btn').onclick = () => {
            gameState.isPlaying = false;
            if (gameState.audio) gameState.audio.pause();
            if (gameState.animationFrame) cancelAnimationFrame(gameState.animationFrame);
            showScreen('menu');
            populateSongs();
        };

        document.getElementById('retry-btn').onclick = () => {
            showScreen('game');
            startCountdown();
        };

        document.getElementById('menu-btn').onclick = () => {
            showScreen('menu');
            populateSongs();
        };

        document.getElementById('gameover-retry-btn').onclick = () => {
            hideGameOver();
            startCountdown();
        };

        document.getElementById('gameover-menu-btn').onclick = () => {
            hideGameOver();
            showScreen('menu');
            populateSongs();
        };

        // ============== INIT ==============
        function init() {
            createParticles();
            populateSongs();
            setTimeout(() => DOM.loading.classList.add('hidden'), 600);
        }

        init();
    </script>
</body>
</html>
